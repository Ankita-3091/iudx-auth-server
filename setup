#!/bin/sh

id=`id | cut -f1 -d'('`
if [ $id != "uid=0" ]
then
	echo
	echo "You must be root to run this script"
	echo
	exit
fi

syspatch

pkg_add curl postgresql-server postgresql-client node
rcctl enable postgresql

touch crl.db.password
touch auth.db.password
touch postgresql.db.password

chmod 400 *.password

head /dev/urandom | sha256 > crl.db.password
head /dev/urandom | sha256 > auth.db.password
head /dev/urandom | sha256 > postgresql.db.password

echo your-telegram-api-key > telegram.apikey
echo your-telegram-chat-id > telegram.chatid

chmod 400 telegram.*
chmod 400 *.sql

crl_password=`cat crl.db.password`
sed -i "s/XXXcrlXXX/$crl_password/" postgresql.sql 

auth_password=`cat auth.db.password`
sed -i "s/XXXauthXXX/$auth_password/" postgresql.sql 

# setup postgresql
cp postgresql.db.password /var/postgresql
chown _postgresql:_postgresql /var/postgresql/postgresql.db.password

cp postgresql.sql /var/postgresql
chown _postgresql:_postgresql /var/postgresql/postgresql.sql

cp setup.postgresql.openbsd /var/postgresql
chown _postgresql:_postgresql /var/postgresql/setup.postgresql.openbsd

chmod u+x /var/postgresql/setup.postgresql.openbsd
su _postgresql -c /var/postgresql/setup.postgresql.openbsd

until su _postgresql -c pg_isready
do
	sleep 1
done

rm -rf /var/postgresql/setup.postgresql.openbsd

cp rc.local /etc/
cp pf.conf /etc/

openssl req -x509 -nodes -days 365 -subj "/CN=localhost" -newkey rsa:2048 -keyout key.pem -out server.pem

git clone --depth=1 https://github.com/rbccps-iisc/node-aperture
cd node-aperture
npm install
npm audit fix --force

cd ..
npm install
npm audit fix --force

echo /sbin/pfctl -t bruteforce -T expire 86400 > /etc/daily.local
echo syspatch >> /etc/daily.local

rcctl disable sndiod slaacd smtpd xenodm 

echo boot > /etc/boot.conf

echo /usr/bin/pkill tmux >> /etc/rc.shutdown
echo /usr/sbin/rcctl stop postgresql >> /etc/rc.shutdown

reboot
